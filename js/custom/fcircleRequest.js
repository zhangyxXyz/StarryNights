var fdata={jsonurl:"",apiurl:"",apipublieurl:"https://hexo-circle-of-friends-zzzyx.vercel.app/",initnumber:20,stepnumber:10,article_sort:"created",error_img:"https://cdn.jsdelivr.net/gh/zhangyxxyz/zhangyxxyz.github.io@latest/images/404.png"};if("undefined"!=typeof fdataUser)for(var key in fdataUser)fdataUser[key]&&(fdata[key]=fdataUser[key]);var article_num="",sortNow="",UrlNow="",friends_num="",container=document.getElementById("cf-container")||document.getElementById("fcircleContainer"),localSortNow=localStorage.getItem("sortNow"),localUrlNow=localStorage.getItem("urlNow");function loadStatistical(t){article_num=t.article_num,friends_num=t.friends_num;var e=`\n\t<div id="cf-state" class="cf-new-add">\n\t  <div class="cf-state-data">\n\t\t<div class="cf-data-friends" onclick="openToShow()">\n\t\t  <span class="cf-label">订阅</span>\n\t\t  <span class="cf-message">${t.friends_num}</span>\n\t\t</div>\n\t\t<div class="cf-data-active" onclick="changeEgg()">\n\t\t  <span class="cf-label">活跃</span>\n\t\t  <span class="cf-message">${t.active_num}</span>\n\t\t</div>\n\t\t<div class="cf-data-article" onclick="clearLocal()">\n\t\t  <span class="cf-label">日志</span>\n\t\t  <span class="cf-message">${t.article_num}</span>\n\t\t</div>\n\t  </div>\n\t  <div id="cf-change">\n\t\t  <span id="cf-change-created" data-sort="created" onclick="changeSort(event)" class="${"created"==sortNow?"cf-change-now":""}">Created</span> | <span id="cf-change-updated" data-sort="updated" onclick="changeSort(event)" class="${"updated"==sortNow?"cf-change-now":""}" >Updated</span>\n\t  </div>\n\t</div>\n\t`,a=`\n\t  <div id="cf-more" class="cf-new-add" onclick="loadNextArticle()"><i class="fas fa-angle-double-down"></i></div>\n\t  <div id="cf-footer" class="cf-new-add">\n\t   <span id="cf-version-up" onclick="checkVersion()"></span>\n\t   <span class="cf-data-lastupdated">更新于：${t.last_updated_time}</span>\n\t\tPowered by <a target="_blank" href="https://github.com/Rock-Candy-Tea/hexo-circle-of-friends" target="_blank">FriendCircle</a>\n\t  </div>\n\t  <div id="cf-overlay" class="cf-new-add" onclick="closeShow()"></div>\n\t  <div id="cf-overshow" class="cf-new-add"></div>\n\t`;container&&(container.insertAdjacentHTML("beforebegin",e),container.insertAdjacentHTML("afterend",a))}function loadArticleItem(t,e,a){var l="",o=a;if(a>article_num&&(o=article_num),e<article_num){for(var n=e;n<o;n++){var r=t[n];l+=`\n\t\t<div class="cf-article">\n\t\t  <a class="cf-article-title" href="${r.link}" target="_blank" rel="noopener nofollow" data-title="${r.title}">${r.title}</a>\n\t\t  <span class="cf-article-floor">${r.floor}</span>\n\t\t  <div class="cf-article-avatar no-lightbox flink-item-icon">\n\t\t\t<img class="cf-img-avatar avatar" src="${r.avatar}" alt="avatar" onerror="this.src='${fdata.error_img}'; this.onerror = null;">\n\t\t\t<a onclick="openMeShow(event)" data-link="${r.link}" class="" target="_blank" rel="noopener nofollow" href="javascript:;"><span class="cf-article-author">${r.author}</span></a>\n\t\t\t<span class="cf-article-time">\n\t\t\t  <span class="cf-time-created" style="${"created"==sortNow?"":"display:none"}"><i class="far fa-calendar-alt">发表于</i>${r.created}</span>\n\t\t\t  <span class="cf-time-updated" style="${"updated"==sortNow?"":"display:none"}"><i class="fas fa-history">更新于</i>${r.updated}</span>\n\t\t\t</span>\n\t\t  </div>\n\t\t</div>\n\t\t`}container.insertAdjacentHTML("beforeend",l),fetchNextArticle()}else document.getElementById("cf-more").outerHTML='<div id="cf-more" class="cf-new-add" onclick="loadNoArticle()"><small>一切皆有尽头！</small></div>'}function loadFcircleShow(t,e){for(var a=`\n\t\t<div class="cf-overshow">\n\t\t  <div class="cf-overshow-head">\n\t\t\t<img class="cf-img-avatar avatar" src="${t.avatar}" alt="avatar" onerror="this.src='${fdata.error_img}'; this.onerror = null;">\n\t\t\t<a class="" target="_blank" rel="noopener nofollow" href="${t.link}">${t.author}</a>\n\t\t  </div>\n\t\t  <div class="cf-overshow-content">\n\t`,l=0;l<t.article_num;l++){var o=e[l];a+=`\n\t\t<p><a class="cf-article-title"  href="${o.link}" target="_blank" rel="noopener nofollow" data-title="${o.title}">${o.title}</a><span>${o.created}</span></p>\n\t  `}a+="</div></div>",document.getElementById("cf-overshow").insertAdjacentHTML("beforeend",a),document.getElementById("cf-overshow").className="cf-show-now"}function fetchNextArticle(){var start=document.getElementsByClassName("cf-article").length,end=start+fdata.stepnumber,articleNum=article_num;if(end>articleNum&&(end=articleNum),start<articleNum){UrlNow=localStorage.getItem("urlNow");var fetchUrl=UrlNow+"rule="+sortNow+"&start="+start+"&end="+end;fetch(fetchUrl,{mode:"cors",headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,OPTIONS,PATCH,DELETE,POST,PUT","Access-Control-Allow-Headers":"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"}}).then((t=>t.json())).then((json=>{var nextArticle=eval(json.article_data);console.log("已预载?rule="+sortNow+"&start="+start+"&end="+end),localStorage.setItem("nextArticle",JSON.stringify(nextArticle))}))}else(start=articleNum)&&(document.getElementById("cf-more").outerHTML='<div id="cf-more" class="cf-new-add" onclick="loadNoArticle()"><small>一切皆有尽头！</small></div>')}function loadNextArticle(){for(var t=JSON.parse(localStorage.getItem("nextArticle")),e="",a=0;a<t.length;a++){var l=t[a];e+=`\n\t\t<div class="cf-article">\n\t\t  <a class="cf-article-title" href="${l.link}" target="_blank" rel="noopener nofollow" data-title="${l.title}">${l.title}</a>\n\t\t  <span class="cf-article-floor">${l.floor}</span>\n\t\t  <div class="cf-article-avatar no-lightbox flink-item-icon">\n\t\t\t<img class="cf-img-avatar avatar" src="${l.avatar}" alt="avatar" onerror="this.src='${fdata.error_img}'; this.onerror = null;">\n\t\t\t<a onclick="openMeShow(event)" data-link="${l.link}" class="" target="_blank" rel="noopener nofollow" href="javascript:;"><span class="cf-article-author">${l.author}</span></a>\n\t\t\t<span class="cf-article-time">\n\t\t\t  <span class="cf-time-created" style="${"created"==sortNow?"":"display:none"}"><i class="far fa-calendar-alt">发表于</i>${l.created}</span>\n\t\t\t  <span class="cf-time-updated" style="${"updated"==sortNow?"":"display:none"}"><i class="fas fa-history">更新于</i>${l.updated}</span>\n\t\t\t</span>\n\t\t  </div>\n\t\t</div>\n\t\t`}container.insertAdjacentHTML("beforeend",e),fetchNextArticle()}function loadNoArticle(){var t=sortNow+"ArticleData";localStorage.removeItem(t),localStorage.removeItem("statisticalData"),document.getElementById("cf-more").remove(),window.scrollTo(0,document.getElementsByClassName("cf-state").offsetTop)}function clearLocal(){localStorage.removeItem("updatedArticleData"),localStorage.removeItem("createdArticleData"),localStorage.removeItem("nextArticle"),localStorage.removeItem("statisticalData"),localStorage.removeItem("sortNow"),localStorage.removeItem("urlNow"),location.reload()}function checkVersion(){var t=fdata.apiurl+"version";fetch(t,{mode:"cors",headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,OPTIONS,PATCH,DELETE,POST,PUT","Access-Control-Allow-Headers":"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"}}).then((t=>t.json())).then((t=>{console.log(t);var e=t.status,a=t.current_version,l=t.latest_version,o=document.getElementById("cf-version-up");o.innerHTML=0==e?"当前版本：v"+a:1==e?"发现新版本：v"+a+" ↦ "+l:"网络错误，检测失败！"}))}function changeEgg(){if(fdata.jsonurl||fdata.apiurl){document.querySelectorAll(".cf-new-add").forEach((t=>t.remove())),localStorage.removeItem("updatedArticleData"),localStorage.removeItem("createdArticleData"),localStorage.removeItem("nextArticle"),localStorage.removeItem("statisticalData"),container.innerHTML="",UrlNow=localStorage.getItem("urlNow");var t=fdata.apipublieurl+"all?";UrlNow!==t?changeUrl=fdata.apipublieurl+"all?":fdata.jsonurl?changeUrl=fdata.apipublieurl+"postjson?jsonlink="+fdata.jsonurl+"&":fdata.apiurl&&(changeUrl=fdata.apiurl+"all?"),console.log(changeUrl),localStorage.setItem("urlNow",changeUrl),FetchFriendCircle(sortNow,changeUrl)}else clearLocal()}function FetchFriendCircle(sortNow,changeUrl){var end=fdata.initnumber,fetchUrl=UrlNow+"rule="+sortNow+"&start=0&end="+end;changeUrl&&(fetchUrl=changeUrl+"rule="+sortNow+"&start=0&end="+end),fetch(fetchUrl,{mode:"cors",headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,OPTIONS,PATCH,DELETE,POST,PUT","Access-Control-Allow-Headers":"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"}}).then((t=>t.json())).then((json=>{var statisticalData=json.statistical_data,articleData=eval(json.article_data),articleSortData=sortNow+"ArticleData";loadStatistical(statisticalData),loadArticleItem(articleData,0,end),localStorage.setItem("statisticalData",JSON.stringify(statisticalData)),localStorage.setItem(articleSortData,JSON.stringify(articleData))}))}function changeSort(t){sortNow=t.currentTarget.dataset.sort,localStorage.setItem("sortNow",sortNow),document.querySelectorAll(".cf-new-add").forEach((t=>t.remove())),container.innerHTML="",changeUrl=localStorage.getItem("urlNow"),initFriendCircle(sortNow,changeUrl),fdata.apiurl&&checkVersion()}function openMeShow(t){t.preventDefault();var e=t.currentTarget.dataset.link.replace(/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,"$1:$2$3");console.log(e);var a="";a=fdata.apiurl?fdata.apiurl+"post?num=5&link="+e:fdata.apipublieurl+"post?num=5&link="+e,"ok"==noClick&&(noClick="no",fetchShow(a))}function closeShow(){document.getElementById("cf-overlay").className-="cf-show-now",document.getElementById("cf-overshow").className-="cf-show-now",document.getElementById("cf-overshow").innerHTML=""}localSortNow&&localUrlNow?(sortNow=localSortNow,UrlNow=localUrlNow):(sortNow=fdata.article_sort,UrlNow=fdata.jsonurl?fdata.apipublieurl+"postjson?jsonlink="+fdata.jsonurl+"&":fdata.apiurl?fdata.apiurl+"all?":fdata.apipublieurl+"all?",console.log("当前模式："+UrlNow),localStorage.setItem("urlNow",UrlNow),localStorage.setItem("sortNow",sortNow));var noClick="ok";function openToShow(){var t="";t=fdata.apiurl?fdata.apiurl+"post":fdata.apipublieurl+"post","ok"==noClick&&(noClick="no",fetchShow(t))}function fetchShow(url){var closeHtml='\n\t  <div class="cf-overshow-close" onclick="closeShow()"></div>\n\t';document.getElementById("cf-overlay").className="cf-show-now",document.getElementById("cf-overshow").insertAdjacentHTML("afterbegin",closeHtml),console.log("开往"+url),fetch(url,{mode:"cors",headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,OPTIONS,PATCH,DELETE,POST,PUT","Access-Control-Allow-Headers":"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"}}).then((t=>t.json())).then((json=>{noClick="ok";var statisticalData=json.statistical_data,articleData=eval(json.article_data);loadFcircleShow(statisticalData,articleData)}))}function initFriendCircle(sortNow,changeUrl){var articleSortData=sortNow+"ArticleData",localStatisticalData=JSON.parse(localStorage.getItem("statisticalData")),localArticleData=JSON.parse(localStorage.getItem(articleSortData));if(container.innerHTML="",localStatisticalData&&localArticleData){loadStatistical(localStatisticalData),loadArticleItem(localArticleData,0,fdata.initnumber),console.log("本地数据加载成功");var fetchUrl=UrlNow+"rule="+sortNow+"&start=0&end="+fdata.initnumber;fetch(fetchUrl,{mode:"cors",headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,OPTIONS,PATCH,DELETE,POST,PUT","Access-Control-Allow-Headers":"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"}}).then((t=>t.json())).then((json=>{var statisticalData=json.statistical_data,articleData=eval(json.article_data),localSnum=localStatisticalData.article_num,newSnum=statisticalData.article_num,localAtile=localArticleData[0].title,newAtile=articleData[0].title;if(localSnum!==newSnum||localAtile!==newAtile){document.getElementById("cf-state").remove(),document.getElementById("cf-more").remove(),document.getElementById("cf-footer").remove(),container.innerHTML="";var articleSortData=sortNow+"ArticleData";loadStatistical(statisticalData),loadArticleItem(articleData,0,fdata.initnumber),localStorage.setItem("statisticalData",JSON.stringify(statisticalData)),localStorage.setItem(articleSortData,JSON.stringify(articleData)),console.log("热更新完成")}else console.log("API数据未更新")}))}else FetchFriendCircle(sortNow,changeUrl),console.log("第一次加载完成")}initFriendCircle(sortNow);